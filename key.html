<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Processing…</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background: linear-gradient(180deg,#3b82f6 0%, #6366f1 100%);
      color: white;
      text-align: center;
    }
    .card {
      background: rgba(255,255,255,0.06);
      padding: 28px;
      border-radius: 12px;
      width: min(420px, 92%);
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
    }
    .muted { opacity: 0.9; font-size: 0.95rem }
    button {
      margin-top: 18px;
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      background: rgba(255,255,255,0.12);
      color: white;
    }
    button[disabled] { opacity: 0.5; cursor: default; }
  </style>

  <!-- Linkvertise protector (deferred) -->
  <script src="https://publisher.linkvertise.com/cdn/linkvertise.js" defer></script>
</head>
<body>
  <div class="card" role="main" aria-live="polite">
    <h1>Preparing your link…</h1>
    <p class="muted" id="status">Please wait while we verify your session. This usually takes a few seconds.</p>
    <button id="manualContinue" disabled>Continue</button>
  </div>

  <script>
    (function () {
      // ====== CONFIG ======
      // Base64-encoded final URL (not shown as plain text in HTML).
      // Replace the base64 string below with your own encoded URL if needed.
      const finalUrlB64 = "aHR0cHM6Ly9kaXNjb3JkLmdnL0tyMnB2UGZFVVI="; // <-- example encoded target
      // If you want to change the provider id, update the numeric id below:
      const LINKVERTISE_ID = 797865;

      // How long we will wait for provider signals before falling back (ms)
      const MAX_WAIT_MS = 20000;

      // ====== INTERNALS ======
      const statusEl = document.getElementById("status");
      const btn = document.getElementById("manualContinue");
      let redirected = false;

      // decode base64 to URL
      function decodeTarget(b64) {
        try {
          // safe decode for browsers
          return decodeURIComponent(atob(b64).split('').map(function(c){
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));
        } catch (e) {
          // fallback: plain atob (less safe for non-ascii)
          try { return atob(b64); } catch(e2) { return null; }
        }
      }

      const finalUrl = decodeTarget(finalUrlB64);

      function safeRedirect() {
        if (redirected) return;
        redirected = true;
        // perform actual navigation
        if (finalUrl) {
          window.location.href = finalUrl;
        } else {
          statusEl.textContent = "Something went wrong. Please try again later.";
        }
      }

      // Manual button: not showing any URL, simply triggers redirect logic
      btn.addEventListener('click', function () {
        if (btn.disabled) return;
        statusEl.textContent = "Continuing…";
        safeRedirect();
      });

      // Initialize provider (as you were instructed to)
      // If linkvertise isn't available yet, the try/catch prevents runtime error.
      try {
        // call it exactly once as per their instructions
        if (typeof linkvertise === "function") {
          linkvertise(LINKVERTISE_ID, { whitelist: [], blacklist: [""] });
        }
      } catch (e) {
        // silent - provider script may not be loaded yet; we'll rely on signals/polling below
        console.warn("Linkvertise init error:", e);
      }

      // If provider dispatches a custom completion event, react to it.
      // (Some integrations emit custom events; this is a safe, non-invasive listener.)
      window.addEventListener("linkvertise-complete", function () {
        statusEl.textContent = "Verification complete — redirecting…";
        safeRedirect();
      }, { once: true });

      // Poll for a hypothetical global flag that some providers set when cleared.
      // This is polite short polling—will stop after MAX_WAIT_MS.
      const start = Date.now();
      const poll = setInterval(function () {
        // Example: provider may set window._linkvertiseAuthorized = true
        if (window._linkvertiseAuthorized === true) {
          clearInterval(poll);
          statusEl.textContent = "Verification complete — redirecting…";
          safeRedirect();
          return;
        }
        // stop polling after the timeout
        if (Date.now() - start > MAX_WAIT_MS) {
          clearInterval(poll);
          // enable the manual continue button so the user can proceed
          statusEl.textContent = "Verification could not be confirmed automatically. Tap Continue to proceed.";
          btn.disabled = false;
        }
      }, 500);

      // Final fallback: if provider signals nothing, redirect automatically after a slightly longer wait.
      setTimeout(function () {
        if (!redirected) {
          // If you prefer to force automatic fallback redirect after timeout, uncomment next line:
          // safeRedirect();
          // For safety & user trust we leave redirect manual after timeout (but you can change behavior).
          if (btn.disabled) {
            // allow manual continue
            statusEl.textContent = "If verification did not complete automatically, press Continue.";
            btn.disabled = false;
          }
        }
      }, MAX_WAIT_MS + 1500);
    })();
  </script>
</body>
</html>
